'use strict';

var https = require('https');
var expressSession = require('express-session');
var passport = require('passport');
var xsenv = require('sap-xsenv');

var additionalHeadersMiddleware = require('./middleware/additional-headers-middleware');
var agents = require('./backend-request/agents');
var authorizationMiddleware = require('./middleware/authorization-middleware');
var cannotProcessRequestMiddleware = require('./middleware/cannot-process-request-middleware');
var compressionMiddleware = require('./middleware/compression-middleware');
var configuration = require('./configuration');
var connect = require('./connect/connect');
var cookieUtils = require('./utils/cookie-utils');
var connectUtilsMiddleware = require('./middleware/connect-utils-middleware');
var errorHandler = require('./middleware/error-handler');
var extensions = require('./extensions/extensions');
var httpMethodMatchingMiddleware = require('./middleware/http-method-matching-middleware');
var jwtRefreshMiddleware = require('./middleware/jwt-refresh-middleware');
var logging = require('./utils/logger');
var loginCallbackMiddleware = require('./middleware/login-callback-middleware');
var loginMiddleware = require('./middleware/login-middleware');
var logoutMiddleware = require('./middleware/logout-middleware');
var memstoreConfig = require('./configuration/memstore-config');
var pathRewritingMiddleware = require('./middleware/path-rewriting-middleware');
var pluginEndpointMiddleware = require('./middleware/plugin-middleware');
var requestHandler = require('./middleware/request-handler');
var secureCookieMiddleware = require('./middleware/secure-cookie-middleware');
var sessionCookieMiddleware = require('./middleware/session-cookie-middleware');
var staticResourceHandler = require('./middleware/static-resource-handler');
var traceRequestMiddleware = require('./middleware/trace-request-middleware');
var welcomePageMiddleware = require('./middleware/welcome-page-middleware');
var whitelistServiceMiddleware = require('./middleware/whitelist-service-middleware');
var xsrfTokenMiddleware = require('./middleware/xsrf-token-middleware');

module.exports = function bootstrap(options) {
  var certificates = xsenv.loadCertificates();
  agents.httpsAgent.options.ca = certificates;
  https.globalAgent.options.ca = certificates;

  var routerConfig = configuration(options);
  var ext = extensions(options.extensions);

  var app = connect();
  app.use(logging.getExpressMiddleware());
  app.use(connectUtilsMiddleware(app));
  app.use(traceRequestMiddleware);

  ext.insertMiddleware('first', app);

  var sessionSecret = cookieUtils.generateSessionSecret();

  app.use(passport.initialize());
  app.use(passport.session());

  var memoryStore = memstoreConfig.getMemoryStore(routerConfig);
  var cookieName = cookieUtils.getSessionCookieName();

  app.set('cookieName', cookieName);
  app.set('memoryStore', memoryStore);
  app.set('routerConfig', routerConfig);
  app.set('sessionCookieKey', sessionSecret);

  app.use(welcomePageMiddleware);
  app.use(pathRewritingMiddleware);
  app.use(expressSession({
    name: cookieName,
    resave: false,
    saveUninitialized: false,
    secret: sessionSecret,
    store: memoryStore,
    cookie: { secure: routerConfig.secureSessionCookie },
    proxy: true
  }));
  if (routerConfig.secureSessionCookie === true) {
    app.use(secureCookieMiddleware);
  }
  app.use(additionalHeadersMiddleware);

  app.use(routerConfig.appConfig.login.callbackEndpoint, loginCallbackMiddleware);
  app.use(loginMiddleware);
  if (routerConfig.jwtRefresh !== 0) {
    app.use(jwtRefreshMiddleware);
  }
  app.use(authorizationMiddleware);
  app.use(xsrfTokenMiddleware);

  var metadataEndpointOptions = routerConfig.appConfig.pluginMetadataEndpoint;
  metadataEndpointOptions && app.use(metadataEndpointOptions, pluginEndpointMiddleware);

  var logout = routerConfig.appConfig.logout;
  logout && logout.logoutEndpoint && app.use(logout.logoutEndpoint, logoutMiddleware);

  var whitelistService = routerConfig.appConfig.whitelistService;
  whitelistService && app.use(whitelistService.endpoint, whitelistServiceMiddleware);

  var compressionOptions = routerConfig.appConfig.compression;
  compressionOptions.enabled && app.use(compressionMiddleware(compressionOptions));

  ext.insertMiddleware('beforeRequestHandler', app);
  app.use(httpMethodMatchingMiddleware);
  app.use(staticResourceHandler);
  app.use(sessionCookieMiddleware(cookieName));

  app.use(requestHandler);

  ext.insertMiddleware('beforeErrorHandler', app);
  app.use(cannotProcessRequestMiddleware);
  app.use(errorHandler);

  return app;
};
