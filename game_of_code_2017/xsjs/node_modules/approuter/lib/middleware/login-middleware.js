'use strict';

var loginProvider = require('./login-provider');
var checkRequest = require('../utils/check-request');
var pathUtil = require('../utils/path-util');
var xhr = require('../xhr-login/xhr');

module.exports = function loginCheck(req, res, next) {
  if (!loginProvider.isLoginRequired(req)) {
    return next();
  }

  if (req.method !== 'GET' && pathUtil.pathAuthenticationType(req) === 'xsuaa') {
    return sendUnauthorizedRequest(next);
  }
  if (checkRequest.isAjaxRequest(req)) {
    return processAjaxCall(req, res, next);
  }

  try {
    var authenticator = loginProvider.getAuthenticator(req, res);
    authenticator(req, res, next);
  } catch (err) {
    if (err === 401) {
      sendUnauthorizedRequest(next, { 'WWW-Authenticate': 'Basic realm="' + xhr.getRealm() + '"' });
    } else {
      next(err);
    }
  }
};

function processAjaxCall(req, res, next) {
  if (xhr.isXhrLoginRequest(req)) {
    xhr.sendLogonChallenge(res);
  } else {
    sendUnauthorizedRequest(next);
  }
}

function sendUnauthorizedRequest(next, headers) {
  var error = new Error('Authentication required');
  error.status = 401;
  error.headers = headers;
  next(error);
}
