'use strict';

var _ = require('lodash');
var util = require('util');
var hdbext = require('sap-hdbext');
var xsenv = require('sap-xsenv');

var globalHanaConfig = xsenv.getServices({ hana: { tag: 'hana' } }).hana;

exports.createConnection = util.deprecate(createConnection, _getDeprecateMessage('createConnection'));
exports.createPool = util.deprecate(createPool, _getDeprecateMessage('createPool'));
exports.middleware = util.deprecate(middleware, _getDeprecateMessage('middleware'));

function _getDeprecateMessage(functionName) {
  return util.format('%s: package sap-hdb-connection is deprecated, use sap-hdbext instead', functionName);
}

function createConnection(cb, samlToken) {
  return hdbext.createConnection(getOptions(samlToken), cb);
}

function createPool(samlToken) {
  return hdbext.getPool(getOptions(samlToken));
}

function middleware(hanaConfig) {
  return hdbext.middleware(hanaConfig || globalHanaConfig);
}

function getOptions(samlToken) {
  return samlToken ? _.extend({ session: { XS_APPLICATIONUSER: samlToken } }, globalHanaConfig) : globalHanaConfig;
}
