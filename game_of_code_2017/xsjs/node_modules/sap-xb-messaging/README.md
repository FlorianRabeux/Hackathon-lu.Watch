xb-messaging
============
Provides messaging capabilities with an external message broker.
Please note, this is a Node Addon and therefore not platform independent.

## Table of contents

* [Prerequisites](#prerequisites)
* [Install](#install)
* [Getting started](#getting-started)
* [API](#api)
* [Further Documentation](#further-documentation)
* [Limitations](#limitations)
* [Supported](#supported)
* [Not supported](#not-supported)


## Prerequisites

* Download the solace 3rd party libraries according to your platform from Nexus (Artifact: solclientc)
* Extend your library search path in regards to the solace libraries

Windows:
```bash
PATH=%PATH%;<solace_dir>/lib
```
Linux:
```bash
export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:<solace_dir>/lib
```
 
## Install

```bash
npm install sap-xb-messaging
```

## Getting started
After installation of the module following example script could be called for publish/subscribe to a topic within one 
script:
```bash
node node_modules/sap-xb-messaging/examples/simplePubSub.js
```

Alternatively the coding below could be used as simple starting point:
```js
var xbmessaging = require('sap-xb-messaging');

var xbclient = xbmessaging.createClient({
  name: 'ClientName',
  host: 'remote host',
  port: 'remote port',
  vpn: 'remote messages vpn',
  user: 'user',
  password: 'password'
});

xbclient.subscribe('topic', xbmessaging.QOS.AT_MOST_ONCE, function(xbmessage){
        console.log("Script callback executed");
        xbmessage.acknowledge();
        console.log('Message acknowledged');
        console.log('Message payload ' + xbmessage.payload().toString('utf8'));

        xbclient.disconnect( function() {
                console.log('Client disconnected');
            }
        );

    }
);

xbclient.connect( function (error) {
        if (!error) {
            console.log('Sucessfuly connected');
            const buf = new Buffer('Hello from node', 'utf8');
            xbclient.publish('test',xbmessaging.QOS.AT_MOST_ONCE,buf);
        }else console.log(error);
    }
);
```

## API

  * <a href="#createclient"><code>sap-xb-messaging.<b>create()</b></code></a>
  * <a href="#client"><code>sap-xb-messaging.<b>Client()</b></code></a>
  * <a href="#connect"><code>sap-xb-messaging.Client#<b>connect()</b></code></a>
  * <a href="#disconnect"><code>sap-xb-messaging.Client#<b>disconnect()</b></code></a>
  * <a href="#getconnectionstate"><code>sap-xb-messaging.Client#<b>getConnectionState()</b></code></a>
  * <a href="#subscribe"><code>sap-xb-messaging.Client#<b>subscribe()</b></code></a>
  * <a href="#unsubscribe"><code>sap-xb-messaging.Client#<b>unsubscribe()</b></code></a>
  * <a href="#publish"><code>sap-xb-messaging.Client#<b>publish()</b></code></a>
  * <a href="#forward"><code>sap-xb-messaging.Client#<b>forward()</b></code></a>
  * <a href="#qualityofservice"><code>sap-xb-messaging.<b>QOS</b></code></a>
  * <a href="#connectionstate"><code>sap-xb-messaging.<b>ConnectionStateCode</b></code></a>


-------------------------------------------------------
<a name="createclient"></a>
### sap-xb-messaging.create(options)

Creates a new client object with the given options and returns a [Client](#client).

-------------------------------------------------------
<a name="client"></a>
### sap-xb-messaging.Client(options)

The `Client` class wraps a client connection to a messaging broker.
The options parameter has the following structure:

```json
{
 	"name": "Client name",
	"type": "Client type (SOLACE)",
	"connection" :
	{
		"host": "remote host",
		"port": "remote post",
		"vpn": "remote messages vpn",
		"user": "user",
		"password": "password",
		"use_ssl": "ssl usage",
		"trust_store": "trust store location"
	}
}
```

#### Event `'connection_state'`

`function (state) {}`

Emitted on connection state changed.

* `state` - new [state](#connectionstate) of the connection

#### Event `'runtime_error'`

`function (error_text, error_code) {}`

Emitted on runtime error in addon client layer

* `error_text`
* `error_code`

-------------------------------------------------------
<a name="connect"></a>
### sap-xb-messaging.Client#connect(done)

Connects to the message broker specified in the [Client object](#client).

* `done` - `function(err) {}` - function callback is fired on operation completed
    * `err` - error object

-------------------------------------------------------
<a name="disconnect"></a>
### sap-xb-messaging.Client#disconnect(done)

Disconnects client session.

* `done` - `function(err) {}` - function callback is fired on operation completed
    * `err` - error object

-------------------------------------------------------
<a name="getconnectionstate"></a>
### sap-xb-messaging.Client#getConnectionState()

Returns the current [state](#connectionstate) of the client connection.

-------------------------------------------------------
<a name="subscribe"></a>
### sap-xb-messaging.Client##subscribe(topic/queue, qos, callback, done)

Subscribe to a topic or queue

* `topic` - `String` topic to subscribe
* `qos` - [quality of service](#qualityofservice)
* `callback` - `function(message) {}` - callback fired on message received
    * `message` - message object
* `done` - `function(err) {}` - function callback is fired on operation completed
    * `err` - error object

#### sap-xb-messaging.XBNodeMessage
Methods:

* `acknowledge` - acknowledge a queue message
* `topic` - returns the topic for the message
* `payload` - returns the message payload
* `isAckRequired` - returns true if acknowledge is required for the message
* `isRedelivered` - returns true if message is redelivered
* `qos` - returns [quality of service](#qualityofservice) flag


-------------------------------------------------------
<a name="unsubscribe"></a>
### sap-xb-messaging.Client#unsubscribe(topic, qos, done)

Unsubscribe for a given topic and QOS.

* `topic` - topic or queue name depending on quality of service
* `qos` - [quality of service](#qualityofservice)
* `done` - `function(err) {}` - function callback is fired on operation completed
    * `err` - error object

-------------------------------------------------------
<a name="publish"></a>
### sap-xb-messaging.Client#publish(topic/queue, qos, payload, done)

Publish a message for a topic.

* `topic` - topic or queue name depending on quality of service
* `qos` - [quality of service](#qualityofservice)
* `payload` - message payload - `Buffer` or `String` object
* `done` - `function(err) {}` - function callback is fired on operation completed
    * `err` - error object

-------------------------------------------------------
<a name="forward"></a>
### sap-xb-messaging.Client#forward(topic/queue, qos, message, done)

Redirect a message to a different topic or queue

* `topic` - topic or queue name depending on quality of service
* `qos` - [quality of service](#qualityofservice)
* `message` - message to redirect
* `done` - `function(err) {}` - function callback is fired on operation completed
    * `err` - error object

-------------------------------------------------------
<a name="qualityofservice"></a>
### sap-xb-messaging.QOS

Possible values for quality of service:

* `AT_MOST_ONCE` - for topics
* `AT_LEAST_ONCE` - for queues

-------------------------------------------------------
<a name="connectionstate"></a>
### sap-xb-messaging.ConnectionStateCode

Possible values for connection state

* `DISCONNECTED` - client session is disconnected
* `CONNECTING` - client session is being connected
* `CONNECTED` - client is connected
* `FAILED` - client connection to broker is failed


-------------------------------------------------------

## Limitations

* Under development

## Supported

### Platform
* Windows(ntamd64) and Linux(linuxx86_64)

### Message Broker

* Solace Appliance and VMR Message Broker

## Not supported

* Other brokers, except Solace Appliance and VMR (so far)
* MQTT protocol (so far)