sap.ui.define(['jquery.sap.global'], function (jQuery) {

    // === AdapterContainer ===

    function AdapterContainer(sContainerKey, sRemoteStorageUrl) {
        this._sRemoteStorageUrl = sRemoteStorageUrl;
        this._sContainerKey = sContainerKey;
        this._oItemMap = new sap.ushell.utils.Map();
    }

    AdapterContainer.prototype.load = function () {
        var oDeferred = new jQuery.Deferred(),
            that = this;

        jQuery.ajax({
            method: "get",
            url: this._sRemoteStorageUrl,
            headers: {
                "x-csrf-token": "Fetch"
            }
        }).done(function(oData, textStatus, jqXHR) {
            that.csrf = jqXHR.getResponseHeader('x-csrf-token');
            jQuery.ajax({
                method: "get",
                url: that._sRemoteStorageUrl,
                dataType: "json"
            }).done(function(oData) {
                jQuery.sap.log.info("Personalization data successfully loaded from " + that._sRemoteStorageUrl, '', 'PersonalizationAdapter');
                if(oData[that._sContainerKey]) {
                    oData = oData[that._sContainerKey];
                }
                that._oItemMap.entries = JSON.parse(JSON.stringify(oData));
                oDeferred.resolve(oData);
            }).fail(function(err) {
                jQuery.sap.log.error("Failed to load personalization data from " + that._sRemoteStorageUrl, JSON.stringify(err), 'PersonalizationAdapter');
                oDeferred.reject(err);
            });
        });

        return oDeferred.promise();
    };

    AdapterContainer.prototype.save = function () {
        var oDeferred = new jQuery.Deferred(),
            data = {},
            that = this;

        data[that._sContainerKey] = that._oItemMap.entries;
        jQuery.ajax({
            method: 'POST',
            url: that._sRemoteStorageUrl,
            contentType: 'application/json',
            data: JSON.stringify(data),
            headers: {
                "x-csrf-token": that.csrf
            }
        }).done(function(oData) {
            if(oData && oData.status === 'ok') {
                oDeferred.resolve();
            } else {
                oDeferred.reject();
            }
        }).fail(function(err) {
            jQuery.sap.log.error("Failed to save personalization data to " + that._sRemoteStorageUrl, JSON.stringify(err), 'PersonalizationAdapter');
            oDeferred.reject(err);
        });
        return oDeferred.promise();
    };

    AdapterContainer.prototype.del = function () {
        var oDeferred = new jQuery.Deferred(),
            that = this;

        jQuery.ajax({
            method: 'DELETE',
            url: that._sRemoteStorageUrl
        }).done(function(oData) {
            if(oData && oData.status === 'ok') {
                oDeferred.resolve();
            } else {
                oDeferred.reject();
            }
        }).fail(function(err) {
            jQuery.sap.log.error("Failed to delete personalization data from " + that._sRemoteStorageUrl, JSON.stringify(err), 'PersonalizationAdapter');
            oDeferred.reject(err);
        });
        return oDeferred.promise();
    };

    AdapterContainer.prototype.getItemKeys = function () {
        return this._oItemMap.keys();
    };

    AdapterContainer.prototype.containsItem = function (sItemKey) {
        return this._oItemMap.containsKey(sItemKey);
    };

    AdapterContainer.prototype.getItemValue = function (sItemKey) {
        return this._oItemMap.get(sItemKey);
    };

    AdapterContainer.prototype.setItemValue = function (sItemKey, oItemValue) {
        this._oItemMap.put(sItemKey, oItemValue);
    };

    AdapterContainer.prototype.delItem = function (sItemKey) {
        this._oItemMap.remove(sItemKey);
    };

    // === Personalization Adapter ===

    function PersonalizationAdapter(oSystem, sParameter, oAdapterConfiguration) {
        this._sRemoteStorageUrl =
            (oAdapterConfiguration && oAdapterConfiguration.config && oAdapterConfiguration.config.remoteStorageUrl);
    }

    PersonalizationAdapter.prototype.getAdapterContainer = function (sContainerKey) {
        return new AdapterContainer(sContainerKey, this._sRemoteStorageUrl);
    };

    PersonalizationAdapter.prototype.delAdapterContainer = function (sContainerKey) {
        return this.getAdapterContainer(sContainerKey).del();
    };

    return PersonalizationAdapter;

}, true);