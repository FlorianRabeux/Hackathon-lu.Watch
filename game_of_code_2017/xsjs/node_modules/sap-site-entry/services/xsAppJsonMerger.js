'use strict';

const fs = require('fs'),
    path = require('path');

class XsAppJsonMerger {

    static getXsAppConfig(workingDir) {
        var wdir = workingDir || __dirname;
        let xsappPath = path.join(wdir, 'xs-app.json');
        console.info('Looking for xs-app.json in: ' + wdir);
        let userXsApp;
        if (fs.existsSync(xsappPath)) {
            userXsApp = JSON.parse(fs.readFileSync(xsappPath, 'utf8'));
        }

        let flpXsApp = XsAppJsonMerger.getFlpConfig();
        let result = flpXsApp;
        if (userXsApp) {
            XsAppJsonMerger.mergeXsApp(userXsApp, flpXsApp);
            result = userXsApp;
        }
        return result;
    }

    static mergeXsApp(userXsApp, flpXsApp) {
        var routes = flpXsApp.routes.slice();
        if (userXsApp && userXsApp.routes) {
            for (var i in userXsApp.routes) {
                routes.push(userXsApp.routes[i]);
            }
        }
        userXsApp.routes = routes;
        userXsApp.welcomeFile = flpXsApp.welcomeFile;
        userXsApp.authenticationMethod = flpXsApp.authenticationMethod;
        userXsApp.logout = flpXsApp.logout;
    }

    static getFlpConfig() {
        return {
            "welcomeFile": "/sites",
            "authenticationMethod": "route",
            "logout": {
                "logoutEndpoint": "/logout",
                "logoutPage": "/logoff.html"
            },
            "routes": [
                {
                    "source": "/logoff.html$",
                    "localDir": "node_modules/sap-site-entry/public",
                    "authenticationType": "none"
                },
                {
                    "source": "/sites",
                    "target": "FioriLaunchpad.html",
                    "localDir": "node_modules/sap-site-entry/public/resources/sap/ushell/",
                    "authenticationType": "xsuaa",
                    "replace": {
                        "pathSuffixes": ["FioriLaunchpad.html"],
                        "vars": ["sapui5url", "buildRuntimeDate"]
                    }
                },
                {
                    "source": "^/resources/sap/ushell/(.*)",
                    "target": "$1",
                    "localDir": "node_modules/sap-site-entry/public/resources/sap/ushell/",
                    "cacheControl": "public, max-age=31536000,must-revalidate"
                }
            ]
        };
    }

}

module.exports = {
    "getXsAppConfig": XsAppJsonMerger.getXsAppConfig
}