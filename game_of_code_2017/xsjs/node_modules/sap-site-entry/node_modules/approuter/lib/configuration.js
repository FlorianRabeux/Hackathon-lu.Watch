'use strict';

var _ = require('lodash');

var appConfig = require('./configuration/app-config');
var environment = require('./environment');
var environmentConfig = require('./configuration/env-config');
var uaaUtils = require('./utils/uaa-utils');

module.exports = function getConfig(parameters) {
  var workingDir = environment.getWorkingDirectory(parameters.workingDir);

  var uaaOptions = uaaUtils.getOptions(workingDir);
  var envConfig = environmentConfig.load(workingDir);
  var routerConfig = {
    serverPort: environment.getPort(parameters.port),
    workingDir: workingDir,
    uaaOptions: uaaOptions,
    appConfig: appConfig.loadConfiguration(workingDir, parameters.xsappConfig || 'xs-app.json', envConfig.destinations, uaaOptions.xsappname)
  };
  routerConfig = _.merge(routerConfig, envConfig);

  if (!routerConfig.sessionTimeout) {
    routerConfig.sessionTimeout = routerConfig.appConfig.sessionTimeout;
  }
  routerConfig.appConfig.mergePluginsIntoRoutes(routerConfig.plugins);

  return routerConfig;
};
