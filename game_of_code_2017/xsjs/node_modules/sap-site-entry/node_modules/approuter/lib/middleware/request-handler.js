'use strict';

var cookieHandler = require('../backend-response/cookie-handler');
var backendOptions = require('../backend-request/options');
var traceUtil = require('../utils/trace-util');

module.exports = function requestHandler(req, res, next) {
  var url = req.internalUrl;
  if (!url) {
    return next();
  }

  var logger = req.loggingContext.getLogger('/Routing');
  var backendRequest = backendOptions.getRequest(req);
  var clientReq = backendRequest();

  if (url.destination.timeout) {
    clientReq.setTimeout(url.destination.timeout);
  }
  clientReq.on('timeout', function () {
    clientReq.abort();
    logger.error('Request to %s failed with a timeout', url.href);
    returnGateWayTimeout(res);
  });
  clientReq.on('error', function (err) {
    logger.error(err, 'Error while forwarding request to %s', url.href);
    returnGateWayError(res, err);
  });
  req.on('error', function (err) {
    logger.error(err, 'Error in reading from incoming request while forwarding to %s', url.href);
    returnGateWayError(res, err);
  });
  req.pipe(clientReq);

  clientReq.on('response', function(clientRes) {
    onResponse(req, res, clientReq, clientRes);
  });
};

function onResponse(req, res, clientReq, clientRes) {
  var tracer = req.loggingContext.getTracer();
  var logger = req.loggingContext.getLogger('/Routing');

  traceUtil.traceBackendResponse(tracer, clientRes);
  var backendCookies = cookieHandler.processCookies(clientRes.headers['set-cookie']);
  if (req.session && backendCookies.sessionCookies.length > 0) {
    cookieHandler.storeSessionCookies(backendCookies.sessionCookies, req);
  }
  for (var headerName in clientRes.headers) {
    if (headerName === 'set-cookie') {
      backendCookies.nonSessionCookies.length && res.setHeader(headerName, backendCookies.nonSessionCookies);
    } else {
      res.setHeader(headerName, clientRes.headers[headerName]);
    }
  }
  res.statusCode = clientRes.statusCode;
  res.statusMessage = clientRes.statusMessage;
  var url = req.internalUrl;
  if (url.destination.timeout) {
    clientRes.setTimeout(url.destination.timeout);
  }
  clientRes.on('timeout', function() {
    clientReq.abort();
    logger.error('Response from %s failed with a timeout', url.href);
    returnGateWayTimeout(res);
  });
  clientRes.on('error', function(err) {
    logger.error(err, 'Error while reading from incoming response (backend request to %s)', url.href);
    returnGateWayError(res, err);
  });
  res.on('error', function(err) {
    logger.error(err, 'Error while sending data to outgoing response (backend request to %s)', url.href);
    returnGateWayError(res, err);
  });
  traceUtil.traceOutgoingResponse(tracer, res);
  clientRes.pipe(res);
}

function returnGateWayError(res, err) {
  if (!res.headersSent) {
    res.writeHead(502); // Bad Gateway
    res.end(err.message);
  }
}

function returnGateWayTimeout(res) {
  if (!res.headersSent) {
    res.writeHead(504);
    res.end('ETIMEDOUT');
  }
}
