'use strict';

module.exports = function additionalHeaders(req, res, next) {
  var routerConfig = req.app.get('routerConfig');
  setDefaultResponseHeaders(routerConfig, res);

  var additionalHeaders = routerConfig.additionalHeaders;
  additionalHeaders.forEach(function addAdditionalHeader(header) {
    var name = Object.keys(header)[0];
    var value = header[name];
    var normalizedName = name.toLowerCase();

    // http://tools.ietf.org/html/rfc7230#section-3.2.2
    // If the value of a header is an array, then it is serialized as comma separated list.
    var currentValue = res.getHeader(normalizedName);
    if (currentValue === undefined) {
      res.setHeader(normalizedName, value);
    } else if (Array.isArray(currentValue)) {
      currentValue.push(value);
    } else { // string
      res.setHeader(normalizedName, [currentValue, value]);
    }
  });

  next();
};

function setDefaultResponseHeaders(routerConfig, res) {
  if (routerConfig.sendXFrameOptions) {
    res.setHeader('x-frame-options', 'SAMEORIGIN');
  }
}
