'use strict';
var cookie = require('cookie');
var cookieUtils = require('../utils/cookie-utils');
var passport = require('passport');
var xhr = require('../xhr-login/xhr');

module.exports = function passportLogin(req, res, next) {
  if (req.method !== 'GET') {
    return next();
  }
  passport.authenticate('oauth2', function (err, user) {
    if (err) {
      return next(err);
    }
    if (!user) {
      res.writeHead(302, { location: '/' });
      res.end();
      return;
    }
    req.logIn(user, function (err) {
      if (err) {
        return next(err);
      }
      if (xhr.isXhrLogin(req)) {
        return xhr.sendLoginSuccessHtml(res);
      }

      if (!req.headers || !req.headers.cookie) {
        return sendRequiredCookieMissing(req, res);
      }

      var cookies = cookie.parse(req.headers.cookie);
      if (!cookies.locationAfterLogin) {
        return sendRequiredCookieMissing(req, res);
      }

      var locationAfterLogin = cookie.serialize('locationAfterLogin', '', { path: '/', maxAge: 0 });
      cookieUtils.setCookie(res, locationAfterLogin);
      res.writeHead(302, { location: cookies.locationAfterLogin });
      res.end();
    });
  })(req, res, next);
};

function sendRequiredCookieMissing(req, res) {
  var logger = req.loggingContext.getLogger('/OAuth');
  var message = 'Required \'locationAfterLogin\' cookie is missing in the request';
  logger.error('Unable to redirect after successful authentication, error: %s', message);

  res.writeHead(400);
  res.end(message);
}
